{% extends "admin/base_site.html" %}
{% load static %}
<style>
  #daily, #monthly, #snapshots {
    display: none;
  }
  
h2 {
  cursor: pointer;
  color: #004aad;
  transition: color 0.2s;
}
h2:hover {
  color: #008cff;
}

</style>
{% block extrahead %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h1 style="text-align:right;">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…ØµØ±Ù Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>

<div style="direction:rtl;">
 
    <h2 onclick="toggleSection('daily')" style="cursor:pointer;" >Ù…ØµØ±Ù Ø±ÙˆØ²Ø§Ù†Ù‡</h2> 
    <div id="daily"  style="margin-bottom:30px;">
	    <div>
	        <canvas id="dailyChart" height="120"></canvas>
		    <script>
document.addEventListener("DOMContentLoaded", function() {
    const ctx = document.getElementById("dailyChart").getContext("2d");
    const dailyLabels = [
        {% for d in daily %}
            "{{ d.date }}",
        {% endfor %}
    ];
    const dailyData = [
        {% for d in daily %}
            {{ d.total_bytes_used }},
        {% endfor %}
    ];

    if (dailyData.length > 0) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dailyLabels,
                datasets: [{
                    label: 'Ù…ØµØ±Ù Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø¨Ø§ÛŒØª)',
                    data: dailyData,
                    borderWidth: 1,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)'
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
});
</script>
</div>
    <div>
        <table class="admin-table">
            <tr><th>Ú©Ø§Ø±Ø¨Ø±</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ù…ØµØ±Ù (Ø¨Ø§ÛŒØª)</th></tr>
            {% for d in daily %}
                <tr><td>{{ d.user }}</td><td>{{ d.date }}</td><td>{{ d.total_bytes_used|filesizeformat }}</td></tr>
            {% empty %}
                <tr><td colspan="3">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>
            {% endfor %}
        </table>
	</div>	
</div>

    <h2 onclick="toggleSection('monthly')" style="cursor:pointer;">Ù…ØµØ±Ù Ù…Ø§Ù‡Ø§Ù†Ù‡</h2>
    <div id="monthly" style="margin-bottom:30px;">
	    <div>
	        <canvas id="dailyChart" height="120"></canvas>
		    <script>
document.addEventListener("DOMContentLoaded", function() {
    const ctx = document.getElementById("dailyChart").getContext("2d");
    const dailyLabels = [
        {% for d in daily %}
            "{{ d.date }}",
        {% endfor %}
    ];
    const dailyData = [
        {% for d in daily %}
            {{ d.total_bytes_used }},
        {% endfor %}
    ];

    if (dailyData.length > 0) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dailyLabels,
                datasets: [{
                    label: 'Ù…ØµØ±Ù Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø¨Ø§ÛŒØª)',
                    data: dailyData,
                    borderWidth: 1,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)'
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
});
</script>
</div>
    <div>			
        <table class="admin-table">
            <tr><th>Ú©Ø§Ø±Ø¨Ø±</th><th>Ø³Ø§Ù„</th><th>Ù…Ø§Ù‡</th><th>Ù…ØµØ±Ù</th></tr>
            {% for m in monthly %}
                <tr><td>{{ m.user}}</td><td>{{ m.year }}</td><td>{{ m.month }}</td><td>{{ m.total_bytes_used|filesizeformat }}</td></tr>
            {% empty %}
                <tr><td colspan="4">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>
            {% endfor %}
        </table>
	</div>	
    </div>

    <h2 onclick="toggleSection('snapshots')" style="cursor:pointer;">Ø§Ø³Ù†Ù¾â€ŒØ´Ø§Øªâ€ŒÙ‡Ø§</h2>
    <div id="snapshots" style="margin-bottom:30px;">        
        <table class="admin-table">
            <tr><th>Ø²Ù…Ø§Ù†</th><th>Ù…ØµØ±Ù Ú©Ù„</th></tr>
            {% for s in snapshots %}
                <tr><td>{{ s.snapshot_time }}</td><td>{{ s.total_bytes| filesizeformat }}</td></tr>
            {% empty %}
                <tr><td colspan="2">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>
            {% endfor %}
        </table>
    </div>

</div>

<script>
  // Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ú†Ø§Ø±Øª (ØªØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø´ÙˆØ¯)
  let dailyChartInstance = null;
  let dailyChartLoading = false; // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú†Ù†Ø¯ fetch Ù‡Ù…Ø²Ù…Ø§Ù†

  // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ø§ÛŒØª Ø¨Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø®ÙˆØ§Ù†Ø§ Ø¯Ø± Ù…Ø­ÙˆØ± Y
  function humanBytesLabel(value) {
    if (value >= 1e9) return (value / 1e9).toFixed(2) + ' GB';
    if (value >= 1e6) return (value / 1e6).toFixed(1) + ' MB';
    if (value >= 1e3) return (value / 1e3).toFixed(1) + ' KB';
    return value + ' B';
  }

  // ØªØ§Ø¨Ø¹ÛŒ Ú©Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ Ùˆ Ú†Ø§Ø±Øª Ø±Ø§ Ù…ÛŒâ€ŒØ³Ø§Ø²Ø¯
  async function loadDailyChart() {
    // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ ÛŒØ§ Ù‡Ù…â€ŒØ§Ú©Ù†ÙˆÙ† Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø³ØªØŒ Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†
    if (dailyChartInstance || dailyChartLoading) return;
    dailyChartLoading = true;
    try {
      // Ù…Ø³ÛŒØ± JSON Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ â€” Ø§Ú¯Ø± Ù†Ø§Ù… URL ØªÙˆ ÙØ±Ù‚ Ø¯Ø§Ø±Ù‡ Ø¹ÙˆØ¶Ø´ Ú©Ù†
      const resp = await fetch("{% url 'report_dashboard' %}");
      if (!resp.ok) throw new Error('Fetch failed: ' + resp.status);
      const data = await resp.json();

      // data Ø¨Ø§ÛŒØ¯ Ø´Ø¨ÛŒÙ‡ { labels: [...], totals: [...] } Ø¨Ø§Ø´Ù‡
      const ctx = document.getElementById('dailyChart').getContext('2d');
      dailyChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels || [],
          datasets: [{
            label: 'Ù…ØµØ±Ù Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø¨Ø§ÛŒØª)',
            data: data.totals || [],
            fill: false,
            tension: 0.2,
            pointRadius: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return humanBytesLabel(value);
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  const v = context.parsed.y ?? context.raw;
                  return humanBytesLabel(v);
                }
              }
            }
          }
        }
      });

    } catch (err) {
      console.error('Error loading daily chart:', err);
    } finally {
      dailyChartLoading = false;
    }
  }

  // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ ÙØ§Ù†Ú©Ø´Ù† toggleSection Ú©Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø§Ø´ØªÛŒ: ÙˆÙ‚ØªÛŒ Ø¨Ø®Ø´ daily Ø¨Ø§Ø² Ø´Ø¯ØŒ Ú†Ø§Ø±Øª Ø±Ø§ Ù„ÙˆØ¯ Ú©Ù†
  function toggleSection(id) {
      const section = document.getElementById(id);
      if (section.style.display === "none" || section.style.display === "") {
          section.style.display = "block";
          // Ø§Ú¯Ø± Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø§Ø³ØªØŒ Ú†Ø§Ø±Øª Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†
          if (id === 'daily') {
              loadDailyChart();
          }
      } else {
          section.style.display = "none";
      }
  }
 document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("daily").style.display = "none";
}); 
</script>
{% endblock %}