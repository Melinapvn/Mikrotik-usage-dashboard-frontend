{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  #daily, #monthly, #snapshots {
    display: none;
  }

  h2 {
    cursor: pointer;
    color: #004aad;
    transition: color 0.2s;
  }
  h2:hover {
    color: #008cff;
  }
</style>

<h1 style="text-align:right;">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…ØµØ±Ù Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>

<div style="direction:rtl;">

  <!-- Ù…ØµØ±Ù Ø±ÙˆØ²Ø§Ù†Ù‡ -->
  <h2 onclick="toggleSection('daily')">Ù…ØµØ±Ù Ø±ÙˆØ²Ø§Ù†Ù‡</h2>
  <div id="daily" style="margin-bottom:30px;">
      <canvas id="dailyChart" height="120"></canvas>
      <div>
          <table class="admin-table">
              <tr><th>Ú©Ø§Ø±Ø¨Ø±</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ù…ØµØ±Ù (Ø¨Ø§ÛŒØª)</th></tr>
              {% for d in daily %}
                  <tr><td>{{ d.user }}</td><td>{{ d.date }}</td><td>{{ d.total_bytes_used|filesizeformat }}</td></tr>
              {% empty %}
                  <tr><td colspan="3">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>
              {% endfor %}
          </table>
      </div>
  </div>

  <!-- Ù…ØµØ±Ù Ù…Ø§Ù‡Ø§Ù†Ù‡ -->
  <h2 onclick="toggleSection('monthly')">Ù…ØµØ±Ù Ù…Ø§Ù‡Ø§Ù†Ù‡</h2>
  <div id="monthly" style="margin-bottom:30px;">
      <canvas id="monthlyChart" height="120"></canvas>
      <div>
          <table class="admin-table">
              <tr><th>Ú©Ø§Ø±Ø¨Ø±</th><th>Ø³Ø§Ù„</th><th>Ù…Ø§Ù‡</th><th>Ù…ØµØ±Ù</th></tr>
              {% for m in monthly %}
                  <tr>
                      <td>{{ m.user }}</td>
                      <td>{{ m.year }}</td>
                      <td>{{ m.month }}</td>
                      <td>{{ m.total_bytes_used|filesizeformat }}</td>
                  </tr>
              {% empty %}
                  <tr><td colspan="4">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>
              {% endfor %}
          </table>
      </div>
  </div>

  <!-- snapshots -->
  <h2 onclick="toggleSection('snapshots')">Ø§Ø³Ù†Ù¾â€ŒØ´Ø§Øªâ€ŒÙ‡Ø§</h2>
  <div id="snapshots" style="margin-bottom:30px;">
      <canvas id="snapshotsChart" height="120"></canvas>
      <table class="admin-table">
          <tr><th>Ø²Ù…Ø§Ù†</th><th>Ù…ØµØ±Ù Ú©Ù„</th></tr>
          {% for s in snapshots %}
              <tr><td>{{ s.snapshot_time }}</td><td>{{ s.total_bytes|filesizeformat }}</td></tr>
          {% empty %}
              <tr><td colspan="2">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>
          {% endfor %}
      </table>
  </div>

</div>

<script>
// Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§
document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("daily").style.display = "none";
    document.getElementById("monthly").style.display = "none";
    document.getElementById("snapshots").style.display = "none";
});

// Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ JS
const dailyLabels = [
    {% for d in daily %}
        "{{ d.date }}",
    {% endfor %}
];
const dailyData = [
    {% for d in daily %}
        {{ d.total_bytes_used }},
    {% endfor %}
];

const monthlyLabels = [
    {% for m in monthly %}
        "{{ m.year }}/{{ m.month }}",
    {% endfor %}
];
const monthlyData = [
    {% for m in monthly %}
        {{ m.total_bytes_used }},
    {% endfor %}
];

const snapshotsLabels = [
    {% for s in snapshots %}
        "{{ s.snapshot_time }}",
    {% endfor %}
];
const snapshotsData = [
    {% for s in snapshots %}
        {{ s.total_bytes }},
    {% endfor %}
];

// Ù†Ù…ÙˆÙ†Ù‡ Ú†Ø§Ø±Øªâ€ŒÙ‡Ø§
let dailyChartInstance = null;
let monthlyChartInstance = null;
let snapshotsChartInstance = null;

// Ø³Ø§Ø®Øª Ú†Ø§Ø±Øªâ€ŒÙ‡Ø§
function loadDailyChart() {
    if (dailyChartInstance) return;
    const ctx = document.getElementById("dailyChart").getContext("2d");
    dailyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: dailyLabels, datasets: [{ label: 'Ù…ØµØ±Ù Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø¨Ø§ÛŒØª)', data: dailyData, backgroundColor:'rgba(75,192,192,0.5)', borderWidth:1 }] },
        options: { scales: { y: { beginAtZero:true } } }
    });
}

function loadMonthlyChart() {
    if (monthlyChartInstance) return;
    const ctx = document.getElementById("monthlyChart").getContext("2d");
    monthlyChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: monthlyLabels, datasets: [{ label: 'Ù…ØµØ±Ù Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ø¨Ø§ÛŒØª)', data: monthlyData, backgroundColor:'rgba(255,159,64,0.5)', borderWidth:1 }] },
        options: { scales: { y: { beginAtZero:true } } }
    });
}

function loadSnapshotsChart() {
    if (snapshotsChartInstance) return;
    const ctx = document.getElementById("snapshotsChart").getContext("2d");
    snapshotsChartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels: snapshotsLabels, datasets: [{ label:'Ù…ØµØ±Ù Ú©Ù„ (Ø¨Ø§ÛŒØª)', data: snapshotsData, borderColor:'rgba(54,162,235,1)', backgroundColor:'rgba(54,162,235,0.2)', fill:true }] },
        options: { scales: { y: { beginAtZero:true } } }
    });
}

// toggle Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´â€ŒÙ‡Ø§ Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú†Ø§Ø±Øª
function toggleSection(id) {
    const section = document.getElementById(id);
    if (section.style.display === "none" || section.style.display === "") {
        section.style.display = "block";
        if (id==='daily') loadDailyChart();
        if (id==='monthly') loadMonthlyChart();
        if (id==='snapshots') loadSnapshotsChart();
    } else {
        section.style.display = "none";
    }
}
</script>

{% endblock %}